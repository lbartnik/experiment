---
title: 'Sample usage #1'
author: "Lukasz A. Bartnik"
date: "May 1, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


Load the `experiment` package. When in interactive mode, it will stash
global environment after each successful top-level command.

```{r}
library(experiment)
library(magrittr)
library(ggplot2)
```
```{r include=FALSE}
theme_set(theme_bw())
```


Build the first model.

```{r}
x <- lm(Sepal.Width ~ Species, iris)
```
```{r stash, include=FALSE}
# becase R Markdown is not compiled in interactive mode this needs
# to be added after every snippet to simulate addTaskCallback
update_current_commit(environment(), bquote(x))
```


Try another model with a different name.

```{r}
y <- lm(Sepal.Width ~ Species + Sepal.Length, iris)
```
```{r stash, include=FALSE}
```


Try one more model, overwrite the first one.

```{r}
x <- lm(Sepal.Width ~ Species + Petal.Length, iris)
```
```{r stash, include=FALSE}
```


Let's see what has been stashed so far:

```{r}
stashed()
commits()
```


Find all three models, extract them from the local stash, and compare
them in one plot.

```{r}
stash_restore(class == 'lm') %>% {
  x <- vapply(., function(x) length(coef(x)), numeric(1))
  y <- vapply(., function(x) summary(x)$adj.r.squared, numeric(1))
  n <- vapply(names(.), shorten, character(1))
  data.frame(coef = x, adj.r.sqrd = y, id = n) %>%
    ggplot + 
    geom_point(aes(x = coef, y = adj.r.sqrd, colour = n))
}
```


Finally, decide which model to put in the persistent storage.
This call will preserve the model object, the input data, and
automatically add tags to the model stored. On top of that, it
will extract the data object from the \code{lm} object and place
a hash instead to save the persistent storage space.

```{r}
```


## Plot graph of commits

Restore a point from the past and make a change.

```{r}
invisible(checkout_commit('d4b3dbca'))
z <- 1
```
```{r stash, include=FALSE}
```

Now go back to the main line and make another change.

```{r}
invisible(checkout_commit('cd992aaa'))
v <- 2
```
```{r stash, include=FALSE}
```

Finally, make a change in the new "branch".

```{r}
invisible(checkout_commit('3b362778'))
z <- 2
```
```{r stash, include=FALSE}
```


Now show all commits and their graph. X axis is ordered according
to time when a commit has been created, Y axis is divided according to
"branches" in the graph of commits.

```{r}
commits()
commit_graph()
```
